## 实际测量
* 严重flicker

![real flicker](Doc\real_flicker.png)

* 中等flicker

![real flicker](Doc\real_flicker1.png)

* 轻微flicker

![real flicker](Doc\real_flicker2.png)

## 理论计算方法
![flicker](Doc\flicker_equation.png)
从实际的测试可以看出来，随着flicker程度的变化，DC值并没有明显的变化，而AC值会越来越小。

## 算法
最简单的方法，采集一堆数据，然后求最大值，最小值，平均值，最后代入上面的公式即可。但是这样抗干扰的能力太弱，电信号必然有高频噪声在。因此需要做一些简单的滤波。

这里采用的简单算法如下：
1. 采集N个周期的数据
2. 升序排序
3. 去掉最大值，最小值
4. 取前面N-1个数的平均值作为最小值
5. 取后面N-1个数的平均值作为最大值
6. 求平均值
7. 代入上面的公式

## 驱动层
很明显，需要使用ADC采样。flicker的周期约为50ms。按照10倍采样率，采样周期5ms。采集N个周期，采集的数据量将会是10*N。因此设计如下：
1. ADC 设置成Timer触发测量，DMA模式
2. Timer 设置周期5ms的PWM
3. DMA总长10*N，开DMA完成中断
4. 中断产生后，切换buffer，并发出信号量，开始算法


注意算法需要在50*N ms内完成。

## 如何自适应亮度
硅光电池对不同的亮度转换不同的电压值，经过放大器之后，输出的电压值可能会饱和或者太低。需要自适应调节反馈电阻。

从实际测量的波形，可以看到DC值其实比较稳定，且很好计算。因此可以利用DC值做自适应的算法。比如说，将DC值控制在1V到2V之间。


## 系统性能
测量周期 50*N ms，因此测量频率大于等于20HZ。
